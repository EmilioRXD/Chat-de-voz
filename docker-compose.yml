version: "3.8"
services:
  backend:
    build: ./backend
    ports:
      - 4010:4010
    environment:
      - PORT=4010
    networks:
      - voice-chat-net
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      # Define router for backend socket.io (HTTPS)
      - traefik.http.routers.voice-backend-secure.rule=Host(`voice.scape.nexus`) && (PathPrefix(`/socket.io`) || PathPrefix(`/minecraft-data`))
      - traefik.http.routers.voice-backend-secure.entrypoints=websecure
      - traefik.http.routers.voice-backend-secure.tls.certresolver=letsencrypt
      - traefik.http.routers.voice-backend-secure.service=voice-backend-service
      # Define router for backend socket.io (HTTP redirect)
      - traefik.http.routers.voice-backend.rule=Host(`voice.scape.nexus`) && (PathPrefix(`/socket.io`) || PathPrefix(`/minecraft-data`))
      - traefik.http.routers.voice-backend.entrypoints=web
      - traefik.http.routers.voice-backend.service=voice-backend-service
      # Service definition
      - traefik.http.services.voice-backend-service.loadbalancer.server.port=4010
      - traefik.http.services.voice-backend-service.loadbalancer.sticky.cookie=true
      - traefik.http.services.voice-backend-service.loadbalancer.sticky.cookie.secure=true

  frontend:
    build: ./frontend
    ports:
      - 4000:4000
    depends_on:
      - backend
    networks:
      - voice-chat-net
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.minecraft-voice-ewtjts-5-web.rule=Host(`voice.scape.nexus`)
      - traefik.http.routers.minecraft-voice-ewtjts-5-web.entrypoints=web
      - traefik.http.services.minecraft-voice-ewtjts-5-web.loadbalancer.server.port=4000
      - traefik.http.routers.minecraft-voice-ewtjts-5-web.service=minecraft-voice-ewtjts-5-web
      - traefik.http.routers.minecraft-voice-ewtjts-5-web.middlewares=redirect-to-https@file
      - traefik.http.routers.minecraft-voice-ewtjts-5-websecure.rule=Host(`voice.scape.nexus`)
      - traefik.http.routers.minecraft-voice-ewtjts-5-websecure.entrypoints=websecure
      - traefik.http.services.minecraft-voice-ewtjts-5-websecure.loadbalancer.server.port=4000
      - traefik.http.routers.minecraft-voice-ewtjts-5-websecure.service=minecraft-voice-ewtjts-5-websecure
      - traefik.http.routers.minecraft-voice-ewtjts-5-websecure.tls.certresolver=letsencrypt

  coturn:
    image: coturn/coturn:latest
    restart: always
    # network_mode: host removed to avoid conflict with networks
    # Using bridge mode with mapped ports below
    # If network_mode: host is not option (e.g. strict dokploy/portainer env), we must map ports explicitly.
    # Given the user context (Dokploy/VPS), using explicit ports is safer for management than host mode which hijacks everything.
    # Let's use standard bridge mode with mapped ports for better control unless performance dictates otherwise.
    # Correction: TURN usually needs a huge UDP range. Mapping 1000 ports in docker-proxy is heavy. 
    # But for a small chat, mapping a smaller range is fine.
    
    # REVISED STRATEGY: Use standard ports but mapped.
    # network_mode: host <-- Let's stick to bridge for cleaner deployment in Dokploy unless it fails.
    
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49152-49162:49152-49162/udp" # Small range for testing (10 ports = 10 streams approx)
    volumes:
      - ./turnusers.txt:/etc/coturn/turnusers.txt
    command: 
      - -n 
      - --log-file=stdout 
      - --min-port=49152 
      - --max-port=49162 
      - --realm=voice.scape.nexus 
      - --external-ip=voice.scape.nexus
      - --user=uservideo:videopassword # Fallback if file fails, or just use command line
      - --lt-cred-mech
      - --fingerprint
      - --no-cli
    networks:
      - voice-chat-net
      - dokploy-network


networks:
  voice-chat-net:
    driver: bridge
  dokploy-network:
    external: true
